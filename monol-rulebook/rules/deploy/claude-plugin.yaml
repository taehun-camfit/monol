# Claude Code Plugin Deployment Rule
# Claude Code 플러그인 배포 규칙

id: deploy-claude-plugin-001
name: Claude Code 플러그인 배포 규칙
description: |
  Claude Code 플러그인을 npm으로 배포할 때 필요한 구조와 설정입니다.

  **핵심 체크리스트:**
  1. 디렉토리 구조 (.claude-plugin/, *-pkg/)
  2. plugin.json 2개 (npm source용, directory source용)
  3. marketplace.json 설정
  4. package.json files 필드
  5. postinstall 스크립트 (known_marketplaces.json 자동 등록)
  6. settings.json 등록
  7. 문서 업데이트 (docs/USER-GUIDE.md, docs/TECHNICAL.md)

category: deploy
tags:
  - claude-code
  - plugin
  - npm
  - deployment

severity: error

examples:
  good:
    - |
      # 올바른 디렉토리 구조
      my-plugin/
      ├── .claude-plugin/
      │   ├── marketplace.json
      │   └── plugin.json         # npm source용
      ├── my-plugin-pkg/
      │   ├── plugin.json         # directory source용
      │   ├── commands/
      │   ├── skills/
      │   └── hooks/
      ├── docs/
      │   ├── USER-GUIDE.md       # 사용자 가이드 (필수!)
      │   └── TECHNICAL.md        # 기술 문서 (필수!)
      ├── scripts/
      │   └── install.js          # postinstall 스크립트 (필수!)
      └── package.json
    - |
      # package.json 필수 설정
      {
        "scripts": {
          "postinstall": "node scripts/install.js"
        },
        "files": [
          ".claude-plugin",
          "my-plugin-pkg",
          "scripts"
        ]
      }
    - |
      # postinstall 스크립트가 known_marketplaces.json에 등록
      ~/.claude/plugins/known_marketplaces.json:
      {
        "my-plugin": {
          "source": { "source": "npm", "package": "my-plugin" },
          "installLocation": "/path/to/node_modules/my-plugin",
          "lastUpdated": "2025-01-18T00:00:00Z"
        }
      }
  bad:
    - |
      # postinstall 스크립트 없음 - 플러그인이 인식되지 않음!
      {
        "files": [".claude-plugin", "my-plugin-pkg"]
        // "scripts": { "postinstall": ... } 누락!
      }
    - |
      # known_marketplaces.json에 미등록
      # settings.json에만 등록하면 작동하지 않음!
    - |
      # 문서 없이 배포 - 사용자가 사용법을 알 수 없음!
      my-plugin/
      ├── .claude-plugin/
      ├── my-plugin-pkg/
      └── package.json
      # docs/USER-GUIDE.md 누락!
      # docs/TECHNICAL.md 누락!

exceptions:
  - 로컬 개발 환경에서 directory source 사용 시

related:
  - git-001

created: "2025-01-18T00:00:00Z"
updated: "2025-01-18T00:00:00Z"
scope: global
enabled: true
autoApply: false

metadata:
  version: "1.0.0"
  status: active
  author: "@kent"
  changelog:
    - version: "1.0.0"
      date: "2025-01-18T00:00:00Z"
      author: "@kent"
      changes: "초기 버전 - known_marketplaces.json 등록 필수 추가"

# 상세 규칙
rules:
  directory_structure:
    description: "필수 디렉토리 구조"
    required:
      - ".claude-plugin/marketplace.json"
      - ".claude-plugin/plugin.json"
      - "{plugin-name}-pkg/plugin.json"
      - "{plugin-name}-pkg/commands/"
      - "scripts/install.js"
      - "package.json"
      - "docs/USER-GUIDE.md"
      - "docs/TECHNICAL.md"
    optional:
      - "{plugin-name}-pkg/skills/"
      - "{plugin-name}-pkg/hooks/"
      - "{plugin-name}-pkg/agents/"
      - "scripts/uninstall.js"
      - "docs/ROADMAP.md"
      - "docs/examples/"

  plugin_json_npm:
    description: ".claude-plugin/plugin.json (npm source용)"
    format: |
      {
        "name": "{plugin-name}",
        "version": "x.x.x",
        "description": "...",
        "author": "...",
        "commands": "{plugin-name}-pkg/commands/",
        "skills": "{plugin-name}-pkg/skills/",
        "hooks": "{plugin-name}-pkg/hooks/"
      }

  plugin_json_directory:
    description: "{plugin-name}-pkg/plugin.json (directory source용)"
    format: |
      {
        "name": "{plugin-name}",
        "version": "x.x.x",
        "description": "...",
        "author": "...",
        "commands": "commands/",
        "skills": "skills/",
        "hooks": "hooks/"
      }

  marketplace_json:
    description: ".claude-plugin/marketplace.json"
    format: |
      {
        "$schema": "https://anthropic.com/claude-code/marketplace.schema.json",
        "name": "{plugin-name}",
        "description": "...",
        "owner": { "name": "..." },
        "plugins": [{
          "name": "{plugin-name}",
          "description": "...",
          "author": { "name": "..." },
          "source": "./{plugin-name}-pkg",
          "category": "productivity"
        }]
      }

  postinstall_script:
    description: "scripts/install.js - known_marketplaces.json 자동 등록 (필수!)"
    critical: true
    note: |
      이 스크립트가 없으면 npm install 후에도 플러그인이 인식되지 않습니다!

      필수 동작:
      1. ~/.claude/settings.json에 extraKnownMarketplaces 등록
      2. ~/.claude/plugins/known_marketplaces.json에 installLocation 등록

  known_marketplaces_registration:
    description: "~/.claude/plugins/known_marketplaces.json 등록"
    critical: true
    format: |
      {
        "{marketplace-name}": {
          "source": {
            "source": "npm",
            "package": "{plugin-name}"
          },
          "installLocation": "/path/to/node_modules/{plugin-name}",
          "lastUpdated": "ISO-8601-timestamp"
        }
      }
    note: |
      settings.json의 extraKnownMarketplaces만으로는 부족합니다!
      known_marketplaces.json에도 등록되어야 Claude Code가 플러그인을 인식합니다.

  package_json:
    description: "package.json 필수 설정"
    required_fields:
      - name
      - version
      - files
      - scripts.postinstall
    files_must_include:
      - ".claude-plugin"
      - "{plugin-name}-pkg"
      - "scripts"

  documentation:
    description: "배포 전 문서 업데이트 (필수)"
    critical: true
    required_files:
      - "docs/USER-GUIDE.md"
      - "docs/TECHNICAL.md"
    update_triggers:
      - 새 커맨드 추가/수정
      - 새 스킬/훅/에이전트 추가
      - API 변경
      - 설정 옵션 변경
      - 버전 업그레이드
    checklist:
      USER-GUIDE.md:
        - 커맨드 레퍼런스 업데이트
        - 사용 예시 추가/수정
        - FAQ 업데이트
      TECHNICAL.md:
        - 아키텍처 다이어그램 업데이트
        - API 문서 업데이트
        - 업그레이드 가이드 추가
    note: |
      문서가 코드와 동기화되지 않으면 사용자 혼란을 야기합니다.
      배포 전 반드시 두 문서를 검토하고 업데이트하세요.

platforms:
  cursor:
    enabled: false
  claude:
    enabled: true
