<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monol Rulebook - Proposals</title>
  <!-- Monol Design System -->
  <link rel="stylesheet" href="../../../../monol-design/monol-design.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            background: '#0a0a0a',
            foreground: '#fafafa',
            card: '#171717',
            'card-foreground': '#fafafa',
            primary: '#f97316',
            'primary-foreground': '#fafafa',
            secondary: '#262626',
            'secondary-foreground': '#fafafa',
            muted: '#262626',
            'muted-foreground': '#a3a3a3',
            accent: '#262626',
            'accent-foreground': '#fafafa',
            border: '#262626',
            input: '#262626',
            ring: '#f97316',
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .sidebar-item:hover { background: #262626; }
    .sidebar-item.active { background: #262626; color: #f97316; }
    .proposal-card { transition: all 0.2s; }
    .proposal-card:hover { background: #1f1f1f; border-color: #404040; }
    .proposal-card.selected { background: #171717; border-left: 2px solid #f97316; }
    .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
    .diff-add { background: rgba(34, 197, 94, 0.1); border-left: 3px solid #22c55e; }
    .diff-remove { background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; }
    .review-btn { transition: all 0.2s; }
    .review-btn:hover { transform: scale(1.02); }
    .filter-btn.active { background: rgba(249, 115, 22, 0.2); color: #f97316; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    @keyframes toastSlide {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes confetti {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(-100px) rotate(720deg); opacity: 0; }
    }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    .slide-in { animation: slideIn 0.3s ease-out; }
    .pulse { animation: pulse 0.3s ease-out; }
    .toast-slide { animation: toastSlide 0.3s ease-out; }

    .modal-backdrop {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
    }
    .progress-bar { transition: width 0.5s ease-out; }
  </style>
</head>
<body class="bg-background text-foreground min-h-screen">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 border-r border-border flex flex-col">
      <div class="p-4 border-b border-border">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center text-white font-bold">R</div>
          <span class="font-semibold">Rulebook</span>
        </div>
        <button class="mt-3 w-full flex items-center justify-between px-3 py-2 bg-secondary rounded-lg text-sm">
          <span>Frontend Team</span>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
      </div>

      <nav class="flex-1 p-2">
        <a href="index.html" class="sidebar-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm text-muted-foreground">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
          </svg>
          홈
        </a>
        <a href="rules.html" class="sidebar-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm text-muted-foreground">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          규칙
        </a>
        <a href="proposals.html" class="sidebar-item active flex items-center gap-3 px-3 py-2 rounded-lg text-sm">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
          </svg>
          제안
          <span id="proposalBadge" class="ml-auto bg-primary text-xs px-2 py-0.5 rounded-full">3</span>
        </a>
        <a href="marketplace.html" class="sidebar-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm text-muted-foreground">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
          </svg>
          마켓플레이스
        </a>
        <a href="analytics.html" class="sidebar-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm text-muted-foreground">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          분석
        </a>
        <a href="insights.html" class="sidebar-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm text-muted-foreground">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
          </svg>
          AI 인사이트
          <span class="ml-auto text-xs px-2 py-0.5 rounded-full text-white" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);">AI</span>
        </a>

        <div class="mt-4 pt-4 border-t border-border">
          <a href="#" class="sidebar-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm text-muted-foreground">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            설정
          </a>
        </div>
      </nav>

      <div class="p-4 border-t border-border">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-sm font-medium">K</div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium truncate">Kent</p>
            <p class="text-xs text-muted-foreground truncate">Admin</p>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden">
      <!-- Proposals List -->
      <div class="w-96 border-r border-border overflow-y-auto">
        <div class="p-4 border-b border-border sticky top-0 bg-background z-10">
          <div class="flex items-center justify-between mb-4">
            <h1 class="text-xl font-semibold">제안</h1>
            <button onclick="openNewProposalModal()" class="px-3 py-1.5 bg-primary text-white rounded-lg text-sm font-medium hover:bg-primary/90 transition-colors">
              + 새 제안
            </button>
          </div>

          <!-- Filters -->
          <div class="flex gap-2" id="filterContainer">
            <button onclick="setFilter('all')" class="filter-btn active px-3 py-1 rounded-full text-sm font-medium transition-colors" data-filter="all">
              전체 (<span id="allCount">3</span>)
            </button>
            <button onclick="setFilter('pending')" class="filter-btn px-3 py-1 bg-secondary text-muted-foreground rounded-full text-sm hover:bg-secondary/80 transition-colors" data-filter="pending">
              대기 중 (<span id="pendingCount">2</span>)
            </button>
            <button onclick="setFilter('mine')" class="filter-btn px-3 py-1 bg-secondary text-muted-foreground rounded-full text-sm hover:bg-secondary/80 transition-colors" data-filter="mine">
              내 제안
            </button>
          </div>
        </div>

        <!-- Proposal Items -->
        <div id="proposalList" class="divide-y divide-border">
          <!-- Proposals will be rendered here -->
        </div>
      </div>

      <!-- Proposal Detail -->
      <div id="proposalDetail" class="flex-1 overflow-y-auto">
        <!-- Detail will be rendered here -->
      </div>
    </main>
  </div>

  <!-- New Proposal Modal -->
  <div id="newProposalModal" class="fixed inset-0 modal-backdrop z-50 hidden items-center justify-center">
    <div class="bg-card border border-border rounded-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-auto fade-in">
      <div class="p-6">
        <h2 class="text-lg font-semibold mb-4">새 제안 작성</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">제안 유형</label>
            <div class="flex gap-2">
              <label class="flex items-center gap-2 px-3 py-2 bg-secondary rounded-lg cursor-pointer hover:bg-secondary/80">
                <input type="radio" name="proposalType" value="update" checked> 수정
              </label>
              <label class="flex items-center gap-2 px-3 py-2 bg-secondary rounded-lg cursor-pointer hover:bg-secondary/80">
                <input type="radio" name="proposalType" value="create"> 생성
              </label>
              <label class="flex items-center gap-2 px-3 py-2 bg-secondary rounded-lg cursor-pointer hover:bg-secondary/80">
                <input type="radio" name="proposalType" value="deprecate"> 폐기
              </label>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">대상 규칙</label>
            <select id="targetRule" class="w-full bg-secondary border border-border rounded-lg px-3 py-2 text-sm">
              <option value="">규칙을 선택하세요</option>
              <option value="error-handling-001">error-handling-001 - 에러 핸들링 규칙</option>
              <option value="naming-variable-001">naming-variable-001 - 변수명 규칙</option>
              <option value="component-structure-001">component-structure-001 - 컴포넌트 구조 규칙</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">제목</label>
            <input type="text" id="proposalTitle" class="w-full bg-secondary border border-border rounded-lg px-3 py-2 text-sm" placeholder="제안 제목을 입력하세요">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">설명</label>
            <textarea id="proposalDescription" class="w-full bg-secondary border border-border rounded-lg px-3 py-2 text-sm resize-none" rows="4" placeholder="변경 사유와 내용을 설명해주세요"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">심각도</label>
            <select id="proposalSeverity" class="w-full bg-secondary border border-border rounded-lg px-3 py-2 text-sm">
              <option value="error">Error (필수)</option>
              <option value="warning">Warning (권장)</option>
              <option value="info">Info (정보)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">리뷰어 지정</label>
            <div class="flex flex-wrap gap-2">
              <label class="flex items-center gap-2 px-3 py-2 bg-secondary rounded-lg cursor-pointer hover:bg-secondary/80">
                <input type="checkbox" name="reviewers" value="kent"> Kent
              </label>
              <label class="flex items-center gap-2 px-3 py-2 bg-secondary rounded-lg cursor-pointer hover:bg-secondary/80">
                <input type="checkbox" name="reviewers" value="mike"> Mike
              </label>
              <label class="flex items-center gap-2 px-3 py-2 bg-secondary rounded-lg cursor-pointer hover:bg-secondary/80">
                <input type="checkbox" name="reviewers" value="jason"> Jason
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="flex justify-end gap-3 p-4 border-t border-border">
        <button onclick="closeNewProposalModal()" class="px-4 py-2 text-sm text-muted-foreground hover:text-foreground">취소</button>
        <button onclick="submitNewProposal()" class="px-4 py-2 bg-primary text-white rounded-lg text-sm hover:bg-primary/90">제안 생성</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"></div>

  <script type="module">
    // API Configuration
    const API_BASE = 'http://localhost:3001/api';
    const TEAM_ID = '1';

    // API Helper
    async function api(endpoint, options = {}) {
      try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
          headers: { 'Content-Type': 'application/json', ...options.headers },
          ...options
        });
        const data = await response.json();
        if (!data.success) throw new Error(data.error?.message || 'API Error');
        return data;
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }

    // Format time helper
    function formatTime(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 60) return `${diffMins}분 전`;
      if (diffHours < 24) return `${diffHours}시간 전`;
      if (diffDays < 7) return `${diffDays}일 전`;
      return `${Math.floor(diffDays / 7)}주 전`;
    }

    // State
    let currentFilter = 'all';
    let selectedProposalId = 1;
    let proposals = [];

    // Load proposals from API
    async function loadProposals() {
      try {
        const params = new URLSearchParams();
        if (currentFilter === 'pending') params.set('status', 'pending');
        if (currentFilter === 'mine') params.set('author', 'kent');

        const queryString = params.toString();
        const response = await api(`/teams/${TEAM_ID}/proposals${queryString ? '?' + queryString : ''}`);

        proposals = response.data.map(p => ({
          ...p,
          createdAt: formatTime(p.createdAt),
          changes: p.changes || [
            { type: 'add', content: `severity: ${p.severity || 'warning'}` }
          ],
          comments: p.comments || []
        }));

        if (proposals.length === 0) {
          proposals = mockProposals;
        }

        if (!proposals.find(p => p.id === selectedProposalId)) {
          selectedProposalId = proposals[0]?.id || 1;
        }

        renderProposalList();
        renderProposalDetail();
      } catch (error) {
        showToast('제안 로드 실패: ' + error.message, 'error');
        proposals = mockProposals;
        renderProposalList();
        renderProposalDetail();
      }
    }

    // Mock fallback data
    const mockProposals = [
      {
        id: 1,
        code: 'PROP-2024-003',
        title: 'API 에러 핸들링 규칙 강화',
        description: '모든 API 호출에 대해 일관된 에러 핸들링 패턴을 적용하도록 규칙을 강화합니다.',
        type: 'update',
        severity: 'error',
        ruleId: 'error-handling-001',
        author: { name: 'Jason', color: 'blue', initial: 'J' },
        reviewers: [
          { name: 'Kent', color: 'green', initial: 'K', status: 'approved', comment: '좋은 제안입니다. 에러 핸들링 일관성은 매우 중요하죠. 다만 재시도 로직의 경우 최대 횟수도 명시하면 좋을 것 같습니다.' },
          { name: 'Mike', color: 'purple', initial: 'M', status: 'pending', comment: null }
        ],
        status: 'pending',
        createdAt: '2시간 전',
        changes: [
          { type: 'remove', content: 'severity: warning' },
          { type: 'add', content: 'severity: error' },
          { type: 'add', content: 'examples:' },
          { type: 'add', content: '  good:' },
          { type: 'add', content: '    - |' },
          { type: 'add', content: '      try {' },
          { type: 'add', content: '        const data = await api.fetch();' },
          { type: 'add', content: '      } catch (error) {' },
          { type: 'add', content: '        logger.error(\'API failed\', error);' },
          { type: 'add', content: '        showToast(\'요청 실패\');' },
          { type: 'add', content: '      }' }
        ],
        comments: [
          { author: { name: 'Kent', color: 'green', initial: 'K' }, content: '좋은 제안입니다. 에러 핸들링 일관성은 매우 중요하죠. 다만 재시도 로직의 경우 최대 횟수도 명시하면 좋을 것 같습니다.', time: '1시간 전', badge: '승인' },
          { author: { name: 'Jason', color: 'blue', initial: 'J' }, content: '@Kent 좋은 의견이에요! 최대 재시도 횟수 3회로 명시하겠습니다.', time: '30분 전', badge: '작성자' }
        ]
      },
      {
        id: 2,
        code: 'PROP-2024-002',
        title: '컴포넌트 파일 구조 규칙 추가',
        description: 'React 컴포넌트의 파일 구조에 대한 새로운 규칙을 제안합니다.',
        type: 'create',
        severity: 'warning',
        ruleId: 'component-structure-001',
        author: { name: 'Mike', color: 'purple', initial: 'M' },
        reviewers: [
          { name: 'Kent', color: 'green', initial: 'K', status: 'approved', comment: '컴포넌트 구조 표준화 좋습니다!' },
          { name: 'Jason', color: 'blue', initial: 'J', status: 'approved', comment: 'LGTM' }
        ],
        status: 'approved',
        createdAt: '1일 전',
        changes: [
          { type: 'add', content: 'id: component-structure-001' },
          { type: 'add', content: 'name: 컴포넌트 파일 구조' },
          { type: 'add', content: 'description: React 컴포넌트 파일 구조 규칙' },
          { type: 'add', content: 'severity: warning' }
        ],
        comments: [
          { author: { name: 'Kent', color: 'green', initial: 'K' }, content: '컴포넌트 구조 표준화 좋습니다!', time: '20시간 전', badge: '승인' },
          { author: { name: 'Jason', color: 'blue', initial: 'J' }, content: 'LGTM', time: '18시간 전', badge: '승인' }
        ]
      },
      {
        id: 3,
        code: 'PROP-2024-001',
        title: '레거시 jQuery 규칙 폐기',
        description: '더 이상 사용하지 않는 jQuery 관련 규칙을 폐기 처리합니다.',
        type: 'deprecate',
        severity: 'info',
        ruleId: 'jquery-style-001',
        author: { name: 'Kent', color: 'green', initial: 'K' },
        reviewers: [
          { name: 'Jason', color: 'blue', initial: 'J', status: 'pending', comment: null },
          { name: 'Mike', color: 'purple', initial: 'M', status: 'pending', comment: null }
        ],
        status: 'pending',
        createdAt: '3일 전',
        changes: [
          { type: 'remove', content: 'status: active' },
          { type: 'add', content: 'status: deprecated' },
          { type: 'add', content: 'deprecated_reason: jQuery는 더 이상 사용하지 않음' }
        ],
        comments: []
      }
    ];

    // Render Functions
    function renderProposalList() {
      const container = document.getElementById('proposalList');
      let filtered = [...proposals];

      if (currentFilter === 'pending') {
        filtered = proposals.filter(p => p.status === 'pending');
      } else if (currentFilter === 'mine') {
        filtered = proposals.filter(p => p.author.name === 'Kent');
      }

      const typeColors = {
        update: { bg: 'bg-yellow-500/20', text: 'text-yellow-400' },
        create: { bg: 'bg-green-500/20', text: 'text-green-400' },
        deprecate: { bg: 'bg-red-500/20', text: 'text-red-400' }
      };

      const severityColors = {
        error: { bg: 'bg-red-500/20', text: 'text-red-400' },
        warning: { bg: 'bg-yellow-500/20', text: 'text-yellow-400' },
        info: { bg: 'bg-blue-500/20', text: 'text-blue-400' }
      };

      container.innerHTML = filtered.map((p, idx) => {
        const typeColor = typeColors[p.type];
        const severityColor = severityColors[p.severity];
        const approvedCount = p.reviewers.filter(r => r.status === 'approved').length;
        const totalReviewers = p.reviewers.length;
        const isSelected = p.id === selectedProposalId;
        const isFullyApproved = approvedCount === totalReviewers;

        return `
          <div onclick="selectProposal(${p.id})" class="proposal-card p-4 cursor-pointer ${isSelected ? 'selected' : ''} fade-in" style="animation-delay: ${idx * 0.05}s;">
            <div class="flex items-start justify-between gap-2 mb-2">
              <div class="flex items-center gap-2">
                <span class="tag ${typeColor.bg} ${typeColor.text}">${p.type}</span>
                <span class="tag ${severityColor.bg} ${severityColor.text}">${p.severity}</span>
              </div>
              <span class="text-xs text-muted-foreground">${p.createdAt}</span>
            </div>
            <h3 class="font-medium mb-1">${p.title}</h3>
            <p class="text-sm text-muted-foreground mb-3 line-clamp-2">${p.description}</p>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <div class="w-6 h-6 bg-${p.author.color}-600 rounded-full flex items-center justify-center text-xs">${p.author.initial}</div>
                <span class="text-sm text-muted-foreground">${p.author.name}</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="${isFullyApproved ? 'text-green-400' : 'text-green-400'} text-sm">${approvedCount}</span>
                <span class="text-muted-foreground text-sm">/</span>
                <span class="text-muted-foreground text-sm">${totalReviewers}</span>
                ${isFullyApproved ? `
                  <svg class="w-4 h-4 text-green-400 ml-1" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                ` : p.status === 'pending' ? `
                  <svg class="w-4 h-4 text-muted-foreground ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                ` : `
                  <svg class="w-4 h-4 text-muted-foreground ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                `}
              </div>
            </div>
          </div>
        `;
      }).join('');

      // Update counts
      document.getElementById('allCount').textContent = proposals.length;
      document.getElementById('pendingCount').textContent = proposals.filter(p => p.status === 'pending').length;
      document.getElementById('proposalBadge').textContent = proposals.filter(p => p.status === 'pending').length;
    }

    function renderProposalDetail() {
      const container = document.getElementById('proposalDetail');
      const proposal = proposals.find(p => p.id === selectedProposalId);

      if (!proposal) {
        container.innerHTML = '<div class="flex items-center justify-center h-full text-muted-foreground">제안을 선택하세요</div>';
        return;
      }

      const typeColors = {
        update: { bg: 'bg-yellow-500/20', text: 'text-yellow-400' },
        create: { bg: 'bg-green-500/20', text: 'text-green-400' },
        deprecate: { bg: 'bg-red-500/20', text: 'text-red-400' }
      };

      const severityColors = {
        error: { bg: 'bg-red-500/20', text: 'text-red-400' },
        warning: { bg: 'bg-yellow-500/20', text: 'text-yellow-400' },
        info: { bg: 'bg-blue-500/20', text: 'text-blue-400' }
      };

      const typeColor = typeColors[proposal.type];
      const severityColor = severityColors[proposal.severity];
      const approvedCount = proposal.reviewers.filter(r => r.status === 'approved').length;
      const totalReviewers = proposal.reviewers.length;
      const progressPercent = (approvedCount / totalReviewers) * 100;
      const isFullyApproved = approvedCount === totalReviewers;
      const canMerge = isFullyApproved && proposal.status !== 'merged';

      container.innerHTML = `
        <div class="p-6 fade-in">
          <!-- Header -->
          <div class="flex items-start justify-between mb-6">
            <div>
              <div class="flex items-center gap-2 mb-2">
                <span class="tag ${typeColor.bg} ${typeColor.text}">${proposal.type}</span>
                <span class="tag ${severityColor.bg} ${severityColor.text}">${proposal.severity}</span>
                <span class="text-sm text-muted-foreground">${proposal.code}</span>
                ${proposal.status === 'merged' ? '<span class="tag bg-purple-500/20 text-purple-400">머지됨</span>' : ''}
              </div>
              <h1 class="text-2xl font-semibold mb-2">${proposal.title}</h1>
              <div class="flex items-center gap-4 text-sm text-muted-foreground">
                <div class="flex items-center gap-2">
                  <div class="w-6 h-6 bg-${proposal.author.color}-600 rounded-full flex items-center justify-center text-xs text-white">${proposal.author.initial}</div>
                  <span>${proposal.author.name}</span>
                </div>
                <span>${proposal.createdAt} 생성</span>
                <span>규칙: ${proposal.ruleId}</span>
              </div>
            </div>
            <div class="flex gap-2">
              ${canMerge ? `
                <button onclick="mergeProposal(${proposal.id})" class="px-4 py-2 bg-purple-500 text-white rounded-lg text-sm hover:bg-purple-600 transition-colors">
                  머지
                </button>
              ` : ''}
              <button class="px-4 py-2 bg-secondary text-muted-foreground rounded-lg text-sm hover:bg-secondary/80 transition-colors">
                편집
              </button>
              <button onclick="closeProposal(${proposal.id})" class="px-4 py-2 bg-red-500/20 text-red-400 rounded-lg text-sm hover:bg-red-500/30 transition-colors">
                닫기
              </button>
            </div>
          </div>

          <!-- Approval Status -->
          <div class="bg-card border border-border rounded-lg p-4 mb-6">
            <h3 class="font-medium mb-3">승인 상태</h3>
            <div class="flex items-center gap-4 mb-4">
              <div class="flex-1 bg-secondary rounded-full h-2">
                <div class="progress-bar ${isFullyApproved ? 'bg-green-500' : 'bg-primary'} h-2 rounded-full" style="width: ${progressPercent}%"></div>
              </div>
              <span class="text-sm font-medium ${isFullyApproved ? 'text-green-400' : ''}">${approvedCount} / ${totalReviewers} 승인</span>
            </div>
            <div class="flex gap-4 flex-wrap">
              ${proposal.reviewers.map(reviewer => `
                <div class="flex items-center gap-2 px-3 py-2 ${reviewer.status === 'approved' ? 'bg-green-500/10 border-green-500/30' : reviewer.status === 'rejected' ? 'bg-red-500/10 border-red-500/30' : 'bg-secondary border-border'} border rounded-lg">
                  <div class="w-8 h-8 bg-${reviewer.color}-600 rounded-full flex items-center justify-center text-sm">${reviewer.initial}</div>
                  <div>
                    <p class="text-sm font-medium">${reviewer.name}</p>
                    <p class="text-xs ${reviewer.status === 'approved' ? 'text-green-400' : reviewer.status === 'rejected' ? 'text-red-400' : 'text-muted-foreground'}">${reviewer.status === 'approved' ? '승인함' : reviewer.status === 'rejected' ? '변경 요청' : '대기 중'}</p>
                  </div>
                  ${reviewer.status === 'approved' ? `
                    <svg class="w-5 h-5 text-green-400 ml-2" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                  ` : reviewer.status === 'rejected' ? `
                    <svg class="w-5 h-5 text-red-400 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                  ` : `
                    <svg class="w-5 h-5 text-muted-foreground ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                  `}
                </div>
              `).join('')}
            </div>
          </div>

          <!-- Description -->
          <div class="bg-card border border-border rounded-lg p-4 mb-6">
            <h3 class="font-medium mb-3">설명</h3>
            <div class="text-sm text-muted-foreground space-y-2">
              <p>${proposal.description}</p>
              <p class="mt-2">주요 변경 사항:</p>
              <ul class="list-disc list-inside ml-2 space-y-1">
                <li>try-catch 블록 필수화</li>
                <li>에러 로깅 표준화</li>
                <li>사용자 피드백 가이드라인 추가</li>
                <li>재시도 로직 권장사항</li>
              </ul>
            </div>
          </div>

          <!-- Changes (Diff) -->
          <div class="bg-card border border-border rounded-lg p-4 mb-6">
            <h3 class="font-medium mb-3">변경 내용</h3>
            <div class="bg-background rounded-lg p-4 font-mono text-sm overflow-x-auto">
              ${proposal.changes.map(change => `
                <div class="${change.type === 'add' ? 'diff-add' : 'diff-remove'} px-3 py-1 mb-1">
                  <span class="${change.type === 'add' ? 'text-green-400' : 'text-red-400'}">${change.type === 'add' ? '+' : '-'} ${change.content}</span>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- Review Actions (only show if user is a reviewer and hasn't reviewed yet) -->
          ${proposal.status === 'pending' ? `
            <div class="bg-card border border-border rounded-lg p-4 mb-6">
              <h3 class="font-medium mb-3">리뷰 작성</h3>
              <textarea
                id="reviewComment"
                class="w-full bg-background border border-border rounded-lg p-3 text-sm resize-none focus:outline-none focus:ring-2 focus:ring-primary"
                rows="3"
                placeholder="리뷰 코멘트를 작성하세요..."
              ></textarea>
              <div class="flex justify-end gap-2 mt-3">
                <button onclick="submitReview(${proposal.id}, 'rejected')" class="review-btn px-4 py-2 bg-red-500/20 text-red-400 rounded-lg text-sm font-medium hover:bg-red-500/30 transition-colors">
                  변경 요청
                </button>
                <button onclick="submitReview(${proposal.id}, 'approved')" class="review-btn px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-medium hover:bg-green-600 transition-colors">
                  승인
                </button>
              </div>
            </div>
          ` : ''}

          <!-- Comments -->
          <div class="bg-card border border-border rounded-lg p-4">
            <h3 class="font-medium mb-4">댓글 (${proposal.comments.length})</h3>

            ${proposal.comments.map(comment => `
              <div class="flex gap-3 mb-4 pb-4 border-b border-border last:border-0 last:mb-0 last:pb-0">
                <div class="w-8 h-8 bg-${comment.author.color}-600 rounded-full flex items-center justify-center text-sm flex-shrink-0">${comment.author.initial}</div>
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="font-medium text-sm">${comment.author.name}</span>
                    <span class="text-xs text-muted-foreground">${comment.time}</span>
                    ${comment.badge ? `<span class="tag ${comment.badge === '작성자' ? 'bg-primary/20 text-primary' : 'bg-green-500/20 text-green-400'} text-xs">${comment.badge}</span>` : ''}
                  </div>
                  <p class="text-sm text-muted-foreground">${comment.content}</p>
                </div>
              </div>
            `).join('')}

            <!-- Add Comment -->
            <div class="flex gap-3 mt-4 pt-4 border-t border-border">
              <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-sm flex-shrink-0">K</div>
              <div class="flex-1 flex gap-2">
                <input
                  type="text"
                  id="newComment"
                  class="flex-1 bg-background border border-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary"
                  placeholder="댓글을 입력하세요..."
                  onkeypress="if(event.key === 'Enter') postComment(${proposal.id})"
                >
                <button onclick="postComment(${proposal.id})" class="px-3 py-2 bg-primary text-white rounded-lg text-sm hover:bg-primary/90 transition-colors">
                  전송
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Event Handlers
    function selectProposal(id) {
      selectedProposalId = id;
      renderProposalList();
      renderProposalDetail();
    }

    function setFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.add('bg-secondary', 'text-muted-foreground');
      });
      document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
      document.querySelector(`[data-filter="${filter}"]`).classList.remove('bg-secondary', 'text-muted-foreground');
      renderProposalList();
    }

    function submitReview(proposalId, status) {
      const comment = document.getElementById('reviewComment').value.trim();
      const proposal = proposals.find(p => p.id === proposalId);

      if (!proposal) return;

      // Find Mike's review (simulating current user is Mike)
      const reviewer = proposal.reviewers.find(r => r.name === 'Mike');
      if (reviewer) {
        reviewer.status = status;
        reviewer.comment = comment || (status === 'approved' ? 'LGTM' : '변경이 필요합니다');

        // Add comment
        proposal.comments.push({
          author: { name: 'Mike', color: 'purple', initial: 'M' },
          content: reviewer.comment,
          time: '방금 전',
          badge: status === 'approved' ? '승인' : '변경 요청'
        });
      }

      renderProposalList();
      renderProposalDetail();

      if (status === 'approved') {
        showToast('제안을 승인했습니다', 'success');

        // Check if fully approved
        const allApproved = proposal.reviewers.every(r => r.status === 'approved');
        if (allApproved) {
          setTimeout(() => {
            showToast('모든 리뷰어가 승인했습니다! 머지가 가능합니다.', 'info');
          }, 500);
        }
      } else {
        showToast('변경을 요청했습니다', 'warning');
      }
    }

    function mergeProposal(proposalId) {
      const proposal = proposals.find(p => p.id === proposalId);
      if (proposal) {
        proposal.status = 'merged';
        renderProposalList();
        renderProposalDetail();
        showToast('제안이 성공적으로 머지되었습니다!', 'success');
      }
    }

    function closeProposal(proposalId) {
      if (confirm('정말로 이 제안을 닫으시겠습니까?')) {
        const idx = proposals.findIndex(p => p.id === proposalId);
        if (idx !== -1) {
          proposals.splice(idx, 1);
          selectedProposalId = proposals[0]?.id || null;
          renderProposalList();
          renderProposalDetail();
          showToast('제안이 닫혔습니다', 'info');
        }
      }
    }

    function postComment(proposalId) {
      const input = document.getElementById('newComment');
      const content = input.value.trim();

      if (!content) {
        showToast('댓글 내용을 입력해주세요', 'error');
        return;
      }

      const proposal = proposals.find(p => p.id === proposalId);
      if (proposal) {
        proposal.comments.push({
          author: { name: 'Kent', color: 'green', initial: 'K' },
          content: content,
          time: '방금 전',
          badge: null
        });

        input.value = '';
        renderProposalDetail();
        showToast('댓글이 등록되었습니다', 'success');
      }
    }

    // Modal Functions
    function openNewProposalModal() {
      document.getElementById('newProposalModal').classList.remove('hidden');
      document.getElementById('newProposalModal').classList.add('flex');
    }

    function closeNewProposalModal() {
      document.getElementById('newProposalModal').classList.add('hidden');
      document.getElementById('newProposalModal').classList.remove('flex');
    }

    function submitNewProposal() {
      const title = document.getElementById('proposalTitle').value.trim();
      const description = document.getElementById('proposalDescription').value.trim();
      const targetRule = document.getElementById('targetRule').value;
      const severity = document.getElementById('proposalSeverity').value;
      const type = document.querySelector('input[name="proposalType"]:checked').value;

      if (!title || !description) {
        showToast('제목과 설명을 입력해주세요', 'error');
        return;
      }

      const newId = Math.max(...proposals.map(p => p.id)) + 1;
      const newProposal = {
        id: newId,
        code: `PROP-2024-${String(newId + 3).padStart(3, '0')}`,
        title: title,
        description: description,
        type: type,
        severity: severity,
        ruleId: targetRule || 'new-rule-001',
        author: { name: 'Kent', color: 'green', initial: 'K' },
        reviewers: [
          { name: 'Jason', color: 'blue', initial: 'J', status: 'pending', comment: null },
          { name: 'Mike', color: 'purple', initial: 'M', status: 'pending', comment: null }
        ],
        status: 'pending',
        createdAt: '방금 전',
        changes: [
          { type: 'add', content: `id: ${targetRule || 'new-rule-001'}` },
          { type: 'add', content: `name: ${title}` },
          { type: 'add', content: `severity: ${severity}` }
        ],
        comments: []
      };

      proposals.unshift(newProposal);
      selectedProposalId = newId;

      closeNewProposalModal();
      renderProposalList();
      renderProposalDetail();
      showToast('새 제안이 생성되었습니다', 'success');

      // Clear form
      document.getElementById('proposalTitle').value = '';
      document.getElementById('proposalDescription').value = '';
    }

    // Toast notification
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');

      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500',
        warning: 'bg-yellow-500'
      };

      const icons = {
        success: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>',
        error: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>',
        info: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
        warning: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>'
      };

      toast.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg toast-slide flex items-center gap-3`;
      toast.innerHTML = `
        ${icons[type]}
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" class="ml-2 hover:opacity-80">×</button>
      `;

      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Close modal on backdrop click
    document.getElementById('newProposalModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('newProposalModal')) {
        closeNewProposalModal();
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeNewProposalModal();
      }
    });

    // Expose functions to global scope for onclick handlers
    window.selectProposal = selectProposal;
    window.setFilter = setFilter;
    window.submitReview = submitReview;
    window.mergeProposal = mergeProposal;
    window.closeProposal = closeProposal;
    window.postComment = postComment;
    window.openNewProposalModal = openNewProposalModal;
    window.closeNewProposalModal = closeNewProposalModal;
    window.submitNewProposal = submitNewProposal;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadProposals();
    });
  </script>
</body>
</html>
