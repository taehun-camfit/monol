name: 'Monol Rulebook Sync'
description: 'Sync rules with Monol Rulebook server and validate against team rules'
author: 'Monol'

branding:
  icon: 'book-open'
  color: 'blue'

inputs:
  api-url:
    description: 'Monol Rulebook API URL'
    required: false
    default: 'https://api.rulebook.monol.dev'
  api-token:
    description: 'API authentication token'
    required: true
  team-slug:
    description: 'Team slug for rule synchronization'
    required: true
  action:
    description: 'Action to perform: validate, sync-push, sync-pull'
    required: false
    default: 'validate'
  rules-path:
    description: 'Path to rules directory'
    required: false
    default: 'rules'
  fail-on-violation:
    description: 'Fail the action if rule violations are found'
    required: false
    default: 'true'
  create-comment:
    description: 'Create PR comment with results'
    required: false
    default: 'true'

outputs:
  violations-count:
    description: 'Number of rule violations found'
  synced-rules-count:
    description: 'Number of rules synced'
  status:
    description: 'Action status: success, warning, failure'

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Monol Rulebook CLI
      shell: bash
      run: npm install -g monol-rulebook

    - name: Run action
      id: rulebook
      shell: bash
      env:
        MONOL_API_URL: ${{ inputs.api-url }}
        MONOL_API_TOKEN: ${{ inputs.api-token }}
        MONOL_TEAM_SLUG: ${{ inputs.team-slug }}
      run: |
        set -e

        echo "ðŸ” Running Monol Rulebook ${{ inputs.action }}..."

        case "${{ inputs.action }}" in
          validate)
            # Validate local rules against team standards
            RESULT=$(monol-rulebook validate --path "${{ inputs.rules-path }}" --json 2>&1 || true)
            echo "$RESULT"

            VIOLATIONS=$(echo "$RESULT" | jq -r '.violations // 0')
            echo "violations-count=$VIOLATIONS" >> $GITHUB_OUTPUT

            if [ "$VIOLATIONS" -gt 0 ] && [ "${{ inputs.fail-on-violation }}" = "true" ]; then
              echo "status=failure" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "status=success" >> $GITHUB_OUTPUT
            fi
            ;;

          sync-push)
            # Push local rules to server
            RESULT=$(monol-rulebook sync --push --path "${{ inputs.rules-path }}" --json 2>&1 || true)
            echo "$RESULT"

            SYNCED=$(echo "$RESULT" | jq -r '.synced // 0')
            echo "synced-rules-count=$SYNCED" >> $GITHUB_OUTPUT
            echo "status=success" >> $GITHUB_OUTPUT
            ;;

          sync-pull)
            # Pull rules from server
            RESULT=$(monol-rulebook sync --pull --path "${{ inputs.rules-path }}" --json 2>&1 || true)
            echo "$RESULT"

            SYNCED=$(echo "$RESULT" | jq -r '.synced // 0')
            echo "synced-rules-count=$SYNCED" >> $GITHUB_OUTPUT
            echo "status=success" >> $GITHUB_OUTPUT
            ;;

          *)
            echo "Unknown action: ${{ inputs.action }}"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
            ;;
        esac

    - name: Create PR comment
      if: inputs.create-comment == 'true' && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const violations = '${{ steps.rulebook.outputs.violations-count }}' || '0';
          const synced = '${{ steps.rulebook.outputs.synced-rules-count }}' || '0';
          const status = '${{ steps.rulebook.outputs.status }}';

          let body = '## ðŸ“š Monol Rulebook Report\n\n';

          if ('${{ inputs.action }}' === 'validate') {
            const icon = status === 'success' ? 'âœ…' : 'âŒ';
            body += `${icon} **Validation**: ${status}\n\n`;
            body += `- Violations found: ${violations}\n`;

            if (parseInt(violations) > 0) {
              body += '\n### Violations\n\n';
              body += 'Please review your code against team coding standards.\n';
            }
          } else {
            body += `âœ… **Sync**: ${synced} rules synchronized\n`;
          }

          body += '\n---\n';
          body += '*Powered by [Monol Rulebook](https://github.com/monol/monol-rulebook)*';

          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: body
          });
