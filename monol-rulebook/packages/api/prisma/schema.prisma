// Monol Rulebook - Database Schema
// Prisma Schema for Team Collaboration Backend

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// User & Auth
// ============================================================================

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  username    String   @unique
  displayName String
  avatarUrl   String?
  githubId    String?  @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ownedTeams      Team[]            @relation("TeamOwner")
  memberships     TeamMember[]
  rules           Rule[]            @relation("RuleAuthor")
  proposals       Proposal[]        @relation("ProposalAuthor")
  reviews         ProposalReview[]
  ruleReviews     RuleReview[]      @relation("UserReviews")
  comments        Comment[]
  notifications   Notification[]
  activities      Activity[]
  favorites       Favorite[]
  helpfulVotes    ReviewHelpful[]
  reviewReports   ReviewReport[]

  @@index([email])
  @@index([username])
  @@index([githubId])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  accessToken  String   @unique
  refreshToken String?  @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([accessToken])
}

// ============================================================================
// Team
// ============================================================================

model Team {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  avatarUrl   String?

  // Settings (JSON)
  settings Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ownerId    String
  owner      User         @relation("TeamOwner", fields: [ownerId], references: [id])
  members    TeamMember[]
  rules      Rule[]
  proposals  Proposal[]
  invites    TeamInvite[]
  activities Activity[]
  adoptedRules RuleAdoption[]

  @@index([slug])
  @@index([ownerId])
}

model TeamMember {
  id     String   @id @default(cuid())
  role   TeamRole @default(MEMBER)
  points Int      @default(0)

  joinedAt DateTime @default(now())

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@index([teamId])
  @@index([userId])
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

model TeamInvite {
  id        String       @id @default(cuid())
  email     String
  role      TeamRole     @default(MEMBER)
  code      String       @unique
  status    InviteStatus @default(PENDING)
  expiresAt DateTime

  createdAt DateTime @default(now())

  // Relations
  teamId    String
  team      Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  inviterId String

  @@index([code])
  @@index([teamId])
  @@index([email])
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

// ============================================================================
// Rule
// ============================================================================

model Rule {
  id          String         @id @default(cuid())
  ruleId      String         // User-defined rule ID (e.g., "naming-001")
  name        String
  description String
  content     String?        @db.Text
  category    String
  severity    RuleSeverity   @default(WARNING)
  tags        String[]
  visibility  RuleVisibility @default(TEAM)

  // Versioning
  version   String @default("1.0.0")
  changelog Json   @default("[]")

  // Marketplace
  listedInMarketplace Boolean @default(false)
  downloads           Int     @default(0)
  rating              Float   @default(0)
  ratingCount         Int     @default(0)
  trendingScore       Float   @default(0)

  // Examples (JSON)
  examples Json @default("{}")

  // Conditions (JSON)
  conditions Json @default("{}")

  // Metadata (JSON)
  metadata Json @default("{}")

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?
  archivedAt  DateTime?

  // Relations
  teamId    String
  team      Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  authorId  String
  author    User       @relation("RuleAuthor", fields: [authorId], references: [id])
  proposals Proposal[]
  comments  Comment[]
  adoptions RuleAdoption[]
  versions  RuleVersion[]
  reviews   RuleReview[]

  // Origin (for adopted rules)
  originRuleId String?
  originRule   Rule?   @relation("RuleOrigin", fields: [originRuleId], references: [id])
  derivedRules Rule[]  @relation("RuleOrigin")

  @@unique([teamId, ruleId])
  @@index([teamId])
  @@index([authorId])
  @@index([category])
  @@index([tags])
  @@index([visibility])
  @@index([listedInMarketplace])
}

enum RuleSeverity {
  ERROR
  WARNING
  INFO
}

enum RuleVisibility {
  PRIVATE
  TEAM
  PUBLIC
}

model RuleVersion {
  id        String @id @default(cuid())
  version   String
  content   Json   // Full rule snapshot
  changes   String @db.Text

  createdAt DateTime @default(now())

  // Relations
  ruleId   String
  rule     Rule   @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  authorId String

  @@index([ruleId])
  @@index([version])
}

model RuleAdoption {
  id            String  @id @default(cuid())
  pinnedVersion String?
  customized    Boolean @default(false)

  // Customizations (JSON diff)
  customizations Json @default("{}")

  createdAt DateTime @default(now())
  adoptedAt DateTime @default(now())

  // Relations
  ruleId        String
  rule          Rule   @relation(fields: [ruleId], references: [id])
  adopterTeamId String
  adopterTeam   Team   @relation(fields: [adopterTeamId], references: [id], onDelete: Cascade)

  @@unique([ruleId, adopterTeamId])
  @@index([ruleId])
  @@index([adopterTeamId])
  @@index([createdAt])
}

model RuleReview {
  id           String   @id @default(cuid())
  rating       Int      // 1-5
  title        String?
  content      String   @db.Text
  pros         String[] @default([])
  cons         String[] @default([])
  verified     Boolean  @default(false)
  helpfulCount Int      @default(0)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  editedAt  DateTime?

  // Relations
  ruleId   String
  rule     Rule   @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  authorId String
  author   User   @relation("UserReviews", fields: [authorId], references: [id])

  // Helpful votes
  helpfulVotes ReviewHelpful[]
  reports      ReviewReport[]

  @@unique([ruleId, authorId])
  @@index([ruleId])
  @@index([authorId])
}

model ReviewHelpful {
  id String @id @default(cuid())

  createdAt DateTime @default(now())

  // Relations
  reviewId String
  review   RuleReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  userId   String
  user     User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId])
  @@index([reviewId])
}

model ReviewReport {
  id      String @id @default(cuid())
  reason  String
  details String? @db.Text
  status  ReportStatus @default(PENDING)

  createdAt DateTime @default(now())
  resolvedAt DateTime?

  // Relations
  reviewId   String
  review     RuleReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  reporterId String
  reporter   User       @relation(fields: [reporterId], references: [id])

  @@index([reviewId])
  @@index([reporterId])
  @@index([status])
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
  DISMISSED
}

// ============================================================================
// Favorites
// ============================================================================

model Favorite {
  id   String       @id @default(cuid())
  type FavoriteType

  createdAt DateTime @default(now())

  // Relations
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  targetId String // ID of the favorited item (rule, collection, team)

  @@unique([userId, type, targetId])
  @@index([userId])
  @@index([type])
}

enum FavoriteType {
  RULE
  COLLECTION
  TEAM
}

// ============================================================================
// Proposal
// ============================================================================

model Proposal {
  id          String         @id @default(cuid())
  title       String
  description String         @db.Text
  type        ProposalType
  status      ProposalStatus @default(DRAFT)

  // Proposed changes (JSON diff)
  changes Json

  // Review requirements
  requiredApprovals Int @default(1)
  currentApprovals  Int @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  submittedAt DateTime?
  mergedAt    DateTime?
  closedAt    DateTime?

  // Relations
  teamId   String
  team     Team             @relation(fields: [teamId], references: [id], onDelete: Cascade)
  ruleId   String?
  rule     Rule?            @relation(fields: [ruleId], references: [id])
  authorId String
  author   User             @relation("ProposalAuthor", fields: [authorId], references: [id])
  reviews  ProposalReview[]
  comments Comment[]

  @@index([teamId])
  @@index([ruleId])
  @@index([authorId])
  @@index([status])
}

enum ProposalType {
  CREATE     // New rule
  UPDATE     // Modify existing
  DELETE     // Remove rule
  DEPRECATE  // Mark as deprecated
}

enum ProposalStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  MERGED
  CANCELLED
}

model ProposalReview {
  id       String       @id @default(cuid())
  decision ReviewDecision
  comment  String?      @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  proposalId String
  proposal   Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  reviewerId String
  reviewer   User     @relation(fields: [reviewerId], references: [id])

  @@unique([proposalId, reviewerId])
  @@index([proposalId])
  @@index([reviewerId])
}

enum ReviewDecision {
  APPROVED
  REJECTED
  CHANGES_REQUESTED
}

// ============================================================================
// Comments & Discussions
// ============================================================================

model Comment {
  id      String @id @default(cuid())
  content String @db.Text

  // For inline comments
  lineNumber Int?
  filePath   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  authorId   String
  author     User      @relation(fields: [authorId], references: [id])
  ruleId     String?
  rule       Rule?     @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  proposalId String?
  proposal   Proposal? @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  // Thread support
  parentId String?
  parent   Comment?  @relation("CommentThread", fields: [parentId], references: [id])
  replies  Comment[] @relation("CommentThread")

  // Reactions (JSON)
  reactions Json @default("{}")

  @@index([ruleId])
  @@index([proposalId])
  @@index([authorId])
  @@index([parentId])
}

// ============================================================================
// Notifications
// ============================================================================

model Notification {
  id      String           @id @default(cuid())
  type    NotificationType
  title   String
  message String
  data    Json             @default("{}")
  read    Boolean          @default(false)

  createdAt DateTime @default(now())

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

enum NotificationType {
  RULE_CREATED
  RULE_UPDATED
  RULE_DELETED
  PROPOSAL_CREATED
  PROPOSAL_APPROVED
  PROPOSAL_REJECTED
  PROPOSAL_MERGED
  REVIEW_REQUESTED
  COMMENT_ADDED
  TEAM_INVITE
  TEAM_JOINED
  MENTION
}

// ============================================================================
// Activity Log
// ============================================================================

model Activity {
  id     String       @id @default(cuid())
  type   ActivityType
  action String
  data   Json         @default("{}")

  createdAt DateTime @default(now())

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id])
  teamId String?
  team   Team?  @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([teamId])
  @@index([type])
  @@index([createdAt])
}

enum ActivityType {
  RULE
  PROPOSAL
  TEAM
  USER
  SYNC
}

// ============================================================================
// Marketplace Collections
// ============================================================================

model Collection {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String  @db.Text
  coverUrl    String?

  // Curated list of rules (JSON array of rule IDs)
  ruleIds String[]

  featured Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  curatorId String

  @@index([slug])
  @@index([featured])
}

// ============================================================================
// Analytics
// ============================================================================

model AnalyticsEvent {
  id        String             @id @default(cuid())
  eventType AnalyticsEventType
  event     String
  data      Json               @default("{}")
  timestamp DateTime           @default(now())

  // Dimensions
  userId String?
  teamId String?
  ruleId String?
  source String?

  @@index([eventType])
  @@index([event])
  @@index([timestamp])
  @@index([userId])
  @@index([teamId])
  @@index([ruleId])
}

enum AnalyticsEventType {
  RULE_VIEW
  RULE_ADOPT
  RULE_SEARCH
  PAGE_VIEW
  USER_ACTION
  SYSTEM
}

model DailyStats {
  id   String   @id @default(cuid())
  date DateTime @db.Date

  teamId String

  // Metrics
  rulesCreated    Int @default(0)
  rulesUpdated    Int @default(0)
  rulesDeleted    Int @default(0)
  proposalsOpened Int @default(0)
  proposalsMerged Int @default(0)
  commentsAdded   Int @default(0)
  activeUsers     Int @default(0)

  @@unique([date, teamId])
  @@index([teamId])
  @@index([date])
}
